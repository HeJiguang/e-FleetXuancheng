# 公安局车辆管理系统 - 页面需求文档

## 1. 系统概述

本系统为公安局车辆管理系统，旨在提供全面的车辆管理功能，包括车辆基本信息管理、里程管理、油耗管理、违章管理和维保管理等。系统采用单用户模式，支持数据导入、多维度分析和趋势可视化。

### 1.2 数据来源
系统数据基于以下Excel文件导入：
- `1-车辆基本信息.xlsx`：车辆台账
- `2-车辆违章数据（1-6月份）.xls`：违章记录
- `3-车辆维保数据.xls`：维保记录
- `4-油耗数据.xls`：油耗记录

## 2. 站点信息架构

### 2.1 顶层框架
- **顶部导航**：整体概览、部门、车辆、数据导入、设置
- **全局筛选器**：
  - 时间范围选择器（按月，支持多月区间）
  - 部门选择器（用于整体概览与部门列表）
  - "Top10/展开全部"切换开关
- **面包屑导航**：显示当前页面层级（如：概览 → 部门 → 具体部门 → 车辆）

### 2.2 页面路由结构
- 整体概览：`GET /`
- 部门列表：`GET /departments`
- 部门详情：`GET /departments/:deptId`
- 车辆列表：`GET /vehicles`
- 车辆详情：`GET /vehicles/:plateNo`
- 数据导入：`GET /imports`
- 设置：`GET /settings`

## 3. 页面详细设计

### 3.1 整体概览页（首页）

**页面路径**：`GET /`

**页面结构**：
1. **顶部全局KPI区**：
   - 车辆总数、部门总数
   - 时间范围选择器（默认最近12个月）

2. **四大管理视图（标签页形式）**：
   - **里程管理**
     - KPI卡片：总里程、平均里程
     - 趋势图：全局月度里程趋势
     - 排名区：部门里程排名（Top10/全部）、车辆里程排名（Top10/全部）
     - 明细表：可查看汇总数据
   
   - **油耗管理**
     - KPI卡片：总加油量、总加油金额、平均百公里油耗
     - 趋势图：全局月度油耗趋势
     - 排名区：部门油耗排名（总量/车均）、车辆百公里油耗排名
     - 明细表：可查看汇总数据
   
   - **违章管理**
     - KPI卡片：总违章次数、平均每车违章次数
     - 趋势图：全局月度违章趋势
     - 排名区：部门违章排名（总量/车均）、车辆违章排名
     - 明细表：可查看汇总数据
   
   - **维保管理**
     - KPI卡片：总维保次数、总维保费用、平均每车维保费用
     - 趋势图：全局月度维保趋势（次数/费用）
     - 排名区：部门维保排名（总量/车均）、车辆维保排名
     - 明细表：可查看汇总数据

**交互功能**：
- 点击部门条目跳转至对应部门详情页
- 点击车辆条目跳转至对应车辆详情页
- 所有排名区域支持"Top10/展开全部"切换
- 展开全部时支持分页与排序

### 3.2 部门列表页

**页面路径**：`GET /departments`

**页面结构**：
1. **筛选区**：
   - 部门名称搜索
   - 时间范围选择器

2. **部门列表表格**：
   - 部门名称
   - 车辆数
   - 区间内总里程
   - 平均百公里油耗
   - 总违章数
   - 总维保费用
   - 操作（查看详情）

**交互功能**：
- 表格支持排序、分页
- 点击部门行或"查看详情"按钮进入部门详情页

### 3.3 部门详情页

**页面路径**：`GET /departments/:deptId`

**页面结构**：
1. **顶部部门信息区**：
   - 部门名称
   - 车辆总数
   - 时间范围选择器（默认最近12个月）

2. **四大管理视图（标签页形式）**：
   - **里程管理**
     - KPI卡片：部门总里程、平均每车里程
     - 趋势图：部门月度里程均值曲线 + 车辆曲线叠加（默认Top10，可展开全部）
     - 排名区：部门内车辆里程排名（Top10/全部）
     - 明细表：车辆月度里程明细
   
   - **油耗管理**
     - KPI卡片：部门总加油量、总加油金额、平均百公里油耗
     - 趋势图：部门月度油耗均值曲线 + 车辆曲线叠加（默认Top10，可展开全部）
     - 排名区：部门内车辆百公里油耗排名
     - 明细表：车辆月度油耗明细
   
   - **违章管理**
     - KPI卡片：部门总违章次数、平均每车违章次数
     - 趋势图：部门月度违章均值曲线 + 车辆曲线叠加（默认Top10，可展开全部）
     - 排名区：部门内车辆违章次数排名
     - 明细表：车辆违章明细
   
   - **维保管理**
     - KPI卡片：部门总维保次数、总维保费用、平均每车维保费用
     - 趋势图：部门月度维保费用均值曲线 + 车辆曲线叠加（默认Top10，可展开全部）
     - 排名区：部门内车辆维保费用排名
     - 明细表：车辆维保明细

**交互功能**：
- 趋势图默认显示"部门均值 + Top10车辆曲线"
- "展开全部"时支持车辆多选与分页
- 点击车辆条目跳转至对应车辆详情页
- 所有排名区域支持"Top10/展开全部"切换
- 明细表支持筛选、排序、导出

### 3.4 车辆列表页

**页面路径**：`GET /vehicles`

**页面结构**：
1. **筛选区**：
   - 车牌号搜索
   - 部门筛选
   - 车型/型号筛选
   - 注册日期范围筛选

2. **车辆列表表格**：
   - 车牌号
   - 部门
   - 车型/型号
   - 最近月份里程
   - 最近月份百公里油耗
   - 最近一次维保时间/费用
   - 操作（查看详情）

**交互功能**：
- 表格支持排序、分页
- 点击车辆行或"查看详情"按钮进入车辆详情页

### 3.5 车辆详情页

**页面路径**：`GET /vehicles/:plateNo`

**页面结构**：
1. **顶部车辆信息区**：
   - 车牌号、部门、车型/型号、注册日期、购置价、座位数
   - 车辆照片（本地存储：`assets/vehicle_photos/{plate_no}.jpg`）
   - 时间范围选择器（默认最近12个月）

2. **四大管理视图（标签页形式）**：
   - **里程管理**
     - KPI卡片：总里程、月均里程
     - 趋势图：车辆月度里程趋势
     - 对比区：本车在全局/部门的里程排名位置
     - 明细表：月度里程明细
   
   - **油耗管理**
     - KPI卡片：总加油量、总加油金额、平均百公里油耗
     - 趋势图：车辆月度油耗趋势
     - 对比区：本车在全局/部门的油耗排名位置
     - 明细表：月度油耗明细（含起止里程、油卡号）
   
   - **违章管理**
     - KPI卡片：总违章次数、月均违章次数
     - 趋势图：车辆月度违章趋势
     - 对比区：本车在全局/部门的违章排名位置
     - 明细表：违章记录明细
   
   - **维保管理**
     - KPI卡片：总维保次数、总维保费用、月均维保费用
     - 趋势图：车辆月度维保趋势（次数/费用）
     - 对比区：本车在全局/部门的维保排名位置
     - 明细表：维保记录明细

**交互功能**：
- 点击部门名称可跳转部门详情
- 明细表支持筛选、排序、导出
- 面包屑可返回车辆列表

### 3.6 数据导入页

**页面路径**：`GET /imports`

**页面结构**：
1. **导入向导**（分栏或标签页形式）：
   - **车辆台账导入**
     - 文件上传（1-车辆基本信息.xlsx）
     - 字段映射预览
     - 数据校验报告
     - 导入确认
   
   - **违章数据导入**
     - 文件上传（2-车辆违章数据.xls，工作表"汇总表"）
     - 字段映射预览
     - 数据校验报告（缺失车辆等）
     - 导入确认
   
   - **维保数据导入**
     - 文件上传（3-车辆维保数据.xls，工作表"3-维修保养明细"）
     - 字段映射预览
     - 数据校验报告
     - 导入确认
   
   - **油耗数据导入**
     - 文件上传（4-油耗数据.xls，工作表"1-6月份"）
     - 字段映射预览
     - 数据校验报告
     - 导入确认

**交互功能**：
- 文件格式校验
- 数据预览与映射确认
- 数据校验（缺失车辆、无效日期、里程异常等）
- 导入进度展示
- 导入结果报告

### 3.7 设置页

**页面路径**：`GET /settings`

**页面结构**：
1. **基础设置**：
   - 部门维护（新增/编辑名称）
   - 车辆照片路径配置（本地路径展示说明）

2. **用户设置**：
   - 用户名展示（MVP不做复杂权限）

**交互功能**：
- 部门CRUD操作
- 设置保存与重置

## 4. 公共组件设计

### 4.1 通用组件
- **TabContainer**：四大管理视图标签页容器
- **KpiCards**：指标卡片组
- **MonthlyLineChart**：月度趋势图（支持多曲线、Top10限流、展开全部时多选/分页）
- **RankingTable**：排名表格（Top10/全部切换、排序）
- **DetailTable**：明细表格（筛选、导出）
- **GlobalFilters**：全局筛选器（月区间、部门选择；车辆/部门页锁定上下文）
- **Breadcrumb**：面包屑导航

### 4.2 组件复用策略
- 所有页面共用同一套标签页组件，仅切换数据源与上下文
- 趋势图组件统一支持"均值曲线+多曲线叠加"，部门页显示"部门均值+车辆曲线"，整体页显示"全局/部门"，车辆页显示单车
- 排名组件统一支持Top10/全部切换与排序
- 明细表组件统一支持筛选、排序、导出

## 5. 交互规则

### 5.1 Top10与展开全部
- 所有排名组件默认显示Top10
- 提供"Top10 | 展开全部"切换开关
- 展开全部时支持分页与排序
- 返回时保持用户选中的时间与过滤器

### 5.2 趋势图交互
- 部门页趋势图默认显示"部门均值 + 车辆Top10曲线"
- 展开全部时使用车辆多选+分页方式展示
- 鼠标悬停显示详细数据
- 支持图例点击隐藏/显示特定曲线

### 5.3 全局规则
- 时间粒度：按月；统计区间=所选开始月到结束月的合计或序列
- 部门归属：使用车辆当前部门（MVP）
- 车辆照片：本地存储，按车牌命名；若无图片则展示占位图
- 标签页默认顺序：里程管理 → 油耗管理 → 违章管理 → 维保管理

## 6. 指标口径定义

### 6.1 里程指标
- **总里程**：sum(distance_km)，基于油耗月表的起止里程差
- **平均里程**：sum(distance_km) / 车辆数
- **里程趋势**：按月聚合的distance_km

### 6.2 油耗指标
- **总加油量**：sum(fuel_liters)
- **总加油金额**：sum(fuel_amount_yuan)
- **平均百公里油耗**：sum(fuel_liters) / (sum(distance_km)/100)
  - 部门/全局加权平均：sum(liters) / (sum(distance)/100)
  - 仅当distance_km > 0时计入

### 6.3 违章指标
- **违章次数**：count(violation)，按violation_time_ts在区间内计数
- **平均违章次数**：count(violation) / 车辆数
- **违章趋势**：按月聚合的violations_count

### 6.4 维保指标
- **维保次数**：count(maintenance)，按finish_time_date在区间内计数
- **维保费用**：sum(cost_amount_yuan)
- **平均维保费用**：sum(cost_amount_yuan) / 车辆数
- **维保趋势**：按月聚合的maintenance_count和maintenance_cost_yuan

## 7. 数据聚合设计

为支持高效查询与展示，设计两张月度聚合表：

### 7.1 车辆月度指标表 (vehicle_monthly_metrics)
- month_year
- plate_no
- department
- distance_km
- fuel_liters
- fuel_amount_yuan
- avg_100km
- violations_count
- maintenance_count
- maintenance_cost_yuan

### 7.2 部门月度指标表 (department_monthly_metrics)
- month_year
- department
- vehicles_count
- distance_km
- fuel_liters
- fuel_amount_yuan
- avg_100km（加权口径）
- violations_count
- maintenance_count
- maintenance_cost_yuan

## 8. 实现优先级

1. 数据库设计与基础表创建
2. 数据导入功能实现
3. 月度聚合表设计与计算逻辑
4. 后端API接口实现
5. 前端通用组件开发
6. 车辆详情页实现
7. 部门详情页实现
8. 整体概览页实现
9. 列表页实现
10. 设置页实现

## 9. 注意事项

- 车辆唯一标识使用车牌号（plate_no）
- 车辆照片存储在本地assets目录
- 所有金额统一使用两位小数
- 里程统一使用公里（km）为单位
- 时间粒度统一为月，违章记录保留到秒
- 图表库建议使用ECharts
